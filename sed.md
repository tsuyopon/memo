# 概要
よく使うsedの構文などについて

# 詳細
以下のサンプルデータを使います
```
$ cat test.txt 
hoge
hoge2
hoge3
fuga
piyo
```

### 置換する
- N番目に見つかった文字を置換する
 - 以下では2番目にみつかった「o」を「_」に置換する
```
$ echo "Hello World" | sed -e "s/o/_/2"
Hello W_rld
```

- sedを実行したい行の範囲指定を行う
 - 2〜3行目を対象として実行している
```
$ sed -e "2,3s/hoge/HOGE/g" test.txt 
hoge
HOGE2
HOGE3
fuga
piyo
```

- 最終行までを対象とする場合
```
$ sed -e "3,4s/g/G/g" test.txt 
hoge
hoge2
hoGe3
fuGa
piyo
```

- ある文字列にマッチした行からある文字列にマッチした行までに対して置換対象とする場合
 - 「hoge2」にマッチした行から「hoge3」にマッチした行に対して置換する
```
$ sed '/hoge2/,/hoge3/ s/oge/ello/g' test.txt 
hoge
hello2
hello3
fuga
piyo
```

- パスを置換する
 - この場合にはdelimiterとして:や@がおすすめ
```
$ echo "/a/b/c" | sed -e "s:/a/b/c:/x/y/z:g"
```
- 特定の正規表現にマッチした行を置換する
```
$ sed -e "s/ho.*/XXX/g" test.txt 
XXX
XXX
XXX
fuga
piyo
```

- マッチした部分の切り出しを利用する
\1や\2, \3で()の中にマッチした部分の切り出しができます。
```
$ echo "id:Synergy:location:Japan" | sed -e "s/id:\(.*\):\(.*\):\(.*\)/Hello,\1,World,\3,\2/g"
Hello,Synergy,World,Japan,location
```

- パスワードからの切り出し
```
$ head -3 /etc/passwd | sed -e "s/^[^:]*:[^:]*:\([^:]*\):\([^:]*\).*/uid:\1,gid:\2/g"
uid:0,gid:0
uid:1,gid:1
uid:2,gid:2
```

- 最短マッチ
```
// うまくいかない例
$ echo "<title>hoge</title>" | sed -e "s/<\(.*\)>.*/\1/g"
title>hoge</title

// うまくいく
// [^>]* に注目してください。これは">"を含まない文字列にマッチします。sedは"<"の次の文字からマッチさせていき、">"を見つけたら、その前でマッチをストップします。
$ echo "<title>hoge</title>" | sed -e "s/<\([^>]*\).*>/\1/g"
title
```

### N行目に挿入したい
以下の例では2行目に挿入します。
```
$  sed -e "2i moge" test.txt
hoge
moge
hoge2
hoge3
fuga
piyo
```

以下の例では2行目の次の行に挿入します。
```
$ sed -e "2a moge" test.txt
hoge
hoge2
moge
hoge3
fuga
piyo
```

### 行が「hoge」の前または後に挿入する
- 前に挿入する場合
```
$ sed -e "/^hoge$/i moge" test.txt
moge
hoge
hoge2
hoge3
fuga
piyo
```

- 後に挿入する場合
```
$ sed -e "/^hoge$/a moge" test.txt
hoge
moge
hoge2
hoge3
fuga
piyo
```

### 行の削除
- 1行目を削除
```
$ sed -e "1d" test.txt 
hoge2
hoge3
fuga
piyo
```

- 3-5行目を削除
```
$ sed -e "3,5d" test.txt 
hoge
hoge2
```

- 最後の行を削除
```
$ sed -e '$d' test.txt      // ※ シングルクォートで挟まないと削除できません。
hoge
hoge2
hoge3
fuga
```

- "hoge"が入った文字列の行を削除
```
$ sed -e "/hoge/d" test.txt 
fuga
piyo
```

# 便利技
- 10文字ずつで改行させる
```
$ sed 's/.\{10\}/&\n/g' test.txt 
```

- 空行を除去
```
$ sed '/^#/d' <input>
```

### ファイルを上書き置換する場合
-i オプションを付与するだけ。
昔のバッカップも取っておきたかったら-ibakなどと指定する

### sedのオプション
```
# 条件式スクリプトを直接指定
-e 'スクリプト'

# 条件式スクリプトが記述されているファイルを指定
-f 'スクリプトファイル名'

# 表示を抑制（明示的にスクリプト中でpをすれば表示も可能）
-n 'スクリプト'

# 拡張正規表現を使ったスクリプトを記述
-r '正規表現を使ったスクリプト'

-i 入力ファイルの上書き

# 上書き前のファイルに拡張子.bakをつけて保管することもできる
sed -i.bak -e '/^#/d' config.txt
```

### sedの条件式
```
行数  処理する行数を指定する
行数,行数   指定した行数間の文字列を処理する。$を指定すると最後の行を表せる
/文字列/     指定した文字列が現れる行を処理する。先頭に「^」を付けると指定した文字列から始まる行，末尾に「$」を付けると指定した文字列で終わる行が対象になる。行数の範囲指定でも利用できる
:ラベル  bおよびtコマンド用のラベル
#コメント   コメント
{..}    括弧（かっこ）内をブロックとして扱う
=   現在の行番号を表示する
a 文字列     文字列を追加する。ただし改行をしたい場合はその前に\を付ける
i 文字列     文字列を挿入する。ただし改行をしたい場合はその前に\を付ける
q   処理を中断しsedを終了する
r ファイル名   指定したファイルを読み出し，追加する
b ラベル     指定したラベルに移動する
t ラベル     s///が成功していれば指定したラベルに移動する
c 文字列     選択している行を文字列に置換する。ただし改行をしたい場合はその前に\を付ける
d   パターン・スペースを削除する
D   パターン・スペース内の最初の改行までを削除する
h   パターン・スペースをホールド・スペースにコピーする
H   パターン・スペースをホールド・スペースに追加する
g   ホールド・スペースをパターン・スペースにコピーする
G   ホールド・スペースをパターン・スペースに追加する
x   ホールド・スペースとパターン・スペースを入れ替える
n   次の行をパターン・スペースに読み込む
N   次の行をパターン・スペースに追加する
p   現在のパターン・スペースを表示する
P   現在のパターン・スペースの最初に現われる改行までを表示する
w ファイル名   現在のパターン・スペースを指定したファイルに書き込む
s/置換条件/置換文字/    置換条件を置換文字に変換する。最後にgを付けた場合は置換条件に当てはまるすべての文字列が置換される
y/変換対象の文字/変換文字/   変換対象の文字を変換文字に変換する
```

# 参考
- http://www.techscore.com/blog/2016/03/14/%E3%81%82%E3%81%88%E3%81%A6%E3%81%84%E3%81%86%E3%81%BB%E3%81%A9%E3%81%A7%E3%82%82%E3%81%AA%E3%81%84sed%E5%85%A5%E9%96%80/
- http://qiita.com/hirohiro77/items/7fe2f68781c41777e507

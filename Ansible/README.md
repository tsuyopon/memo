# 概要
Ansibleについてのコマンドメモ
Vagrantのセットアップ方法はGETTING_STARTED.mdを参考にしてください。


# 詳細


## Inventory
### 指定したインベントリの対象ホスト名を表示する
以下の例ではインベントリファイルとしてhostsというファイル名を指定している
```
$ ansible all --list-hosts -i hosts
  hosts (2):
    node1
    node2
```

### インベントリ中のnodeの情報の詳細を表示する
```
$ cat hosts 
[testgroup]
node1 ansible_host=node1 ansible_port=2001 ansible_user=vagrant ansible_ssh_private_key_file=/Users/tsuyoshi/.vagrant/machines/node1/virtualbox/private_key
node2 ansible_host=node2 ansible_port=2002 ansible_user=vagrant ansible_ssh_private_key_file=/Users/tsuyoshi/.vagrant/machines/node1/virtualbox/private_key
[~/ansible-test]$ ansible-inventory -i hosts --list
{
    "_meta": {
        "hostvars": {
            "node1": {
                "ansible_host": "node1",
                "ansible_port": 2001,
                "ansible_ssh_private_key_file": "/Users/tsuyoshi/.vagrant/machines/node1/virtualbox/private_key",
                "ansible_user": "vagrant"
            },
            "node2": {
                "ansible_host": "node2",
                "ansible_port": 2002,
                "ansible_ssh_private_key_file": "/Users/tsuyoshi/.vagrant/machines/node1/virtualbox/private_key",
                "ansible_user": "vagrant"
            }
        }
    },
    "all": {
        "children": [
            "ungrouped",
            "testgroup"
        ]
    },
    "testgroup": {
        "hosts": [
            "node1",
            "node2"
        ]
    }
}
```

## モジュール

### 搭載されているモジュール一覧を表示する
下記コマンドの出力結果は8000行近くもあるので、ビルトインのモジュールだけを表示している。
```
$ ansible-doc -l > log.txt
$ grep ansible.builtin log.txt
ansible.builtin.add_host                                                                        Add a host (and alternatively a group) to the ansible-playboo...
ansible.builtin.apt                                                                             ...                  
ansible.builtin.apt_key                                                                         Add...               
ansible.builtin.apt_repository                                                                  Add and re...        
ansible.builtin.assemble                                                                        Assemble configuration...
ansible.builtin.assert                                                                          Asserts given...     
ansible.builtin.async_status                                                                    Obtain status...     
ansible.builtin.blockinfile                                                                     Insert/update/remove a text block surro...
ansible.builtin.command                                                                         Execut...            
ansible.builtin.copy                                                                            Copy file...         
ansible.builtin.cron                                                                            Manage cron....      
ansible.builtin.debconf                                                                         Con...               
ansible.builtin.debug                                                                           Print statem...      
ansible.builtin.dnf                                                                             Manages packages with the ...
ansible.builtin.dpkg_selections                                                                 Dpkg package...      
ansible.builtin.expect                                                                          Executes a command an...
ansible.builtin.fail                                                                            Fai...               
ansible.builtin.fetch                                                                           Fetch fi...          
ansible.builtin.file                                                                            Manage file...       
ansible.builtin.find                                                                            Return a list of files based...
ansible.builtin.gather_facts                                                                    Gathers fac...       
ansible.builtin.get_url                                                                         Downloads files from HTTP, ...
ansible.builtin.getent                                                                          A wrapper to th...   
ansible.builtin.git                                                                             Deploy software (or file...
ansible.builtin.group                                                                           ...                  
ansible.builtin.group_by                                                                        Create Ansible ...   
ansible.builtin.hostname                                                                        ...                  
ansible.builtin.import_playbook                                                                 ...                  
ansible.builtin.import_role                                                                     Impo...              
ansible.builtin.import_tasks                                                                    ...                  
ansible.builtin.include_role                                                                    Lo...                
ansible.builtin.include_tasks                                                                   Dynamicall...        
ansible.builtin.include_vars                                                                    Load variables from files, dyna...
ansible.builtin.iptables                                                                        ...                  
ansible.builtin.known_hosts                                                                     Add or remove a host from t...
ansible.builtin.lineinfile                                                                      Manag...             
ansible.builtin.meta                                                                            Exec...              
ansible.builtin.package                                                                         Gener...             
ansible.builtin.package_facts                                                                   Package...           
ansible.builtin.pause                                                                           Pau...               
ansible.builtin.ping                                                                            Try to connect to host, verify a usable python and ret...
ansible.builtin.pip                                                                             Manages Python...    
ansible.builtin.raw                                                                             Executes a low-d...  
ansible.builtin.reboot                                                                          ...                  
ansible.builtin.replace                                                                         Replace all instances of a particular string in a file using a back-referenc...
ansible.builtin.rpm_key                                                                         Adds or removes a gp...
ansible.builtin.script                                                                          Runs a local script on a remote node ...
ansible.builtin.service                                                                         ...                  
ansible.builtin.service_facts                                                                   Return service state inf...
ansible.builtin.set_fact                                                                        Set host va...       
ansible.builtin.set_stats                                                                       Define and display stats for th...
ansible.builtin.setup                                                                           Gathers fac...       
ansible.builtin.shell                                                                           Execute shel...      
ansible.builtin.slurp                                                                           Slurps a f...        
ansible.builtin.stat                                                                            Retrieve file ...    
ansible.builtin.subversion                                                                      Deploys a ...        
ansible.builtin.systemd                                                                         ...                  
ansible.builtin.systemd_service                                                                 ...                  
ansible.builtin.sysvinit                                                                        ...                  
ansible.builtin.tempfile                                                                        Creates temporary ...
ansible.builtin.template                                                                        Template a file...   
ansible.builtin.unarchive                                                                       Unpacks an archive after (optionally) copying it f...
ansible.builtin.uri                                                                             Inter...             
ansible.builtin.user                                                                            ...                  
ansible.builtin.validate_argument_spec                                                          Validat...           
ansible.builtin.wait_for                                                                        Waits for a condit...
ansible.builtin.wait_for_connection                                                             Waits until remote syste...
ansible.builtin.yum                                                                             Manages packages with the ...
ansible.builtin.yum_repository                                                                  Add or re...         
ansible.builtin.include                                                                         ...                  
```

### モジュールを実行する
```
$ ansible all -m ping -i hosts 
node2 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    },
    "changed": false,
    "ping": "pong"
}
node1 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    },
    "changed": false,
    "ping": "pong"
}
```

### モジュールのドキュメントを確認する
ansible-docで確認できるようです。
```
$ ansible-doc yum
```

### setupにより自動集した情報を表示する
出力量が非常に多いので割愛しますが、各種ノードの構成情報が大量に出力されます。
```
$ ansible all -i hosts -m setup
node2 | SUCCESS => {
    "ansible_facts": {
        "ansible_all_ipv4_addresses": [
            "10.0.2.15",
            "192.168.33.12"
        ],  

(snip)

node1 | SUCCESS => {
    "ansible_facts": {
        "ansible_all_ipv4_addresses": [
            "10.0.2.15",
            "192.168.33.11"
        ],
        "ansible_all_ipv6_addresses": [
            "fe80::4461:378d:9237:7c4a",
            "fe80::a00:27ff:feb4:4bea"
        ],
        "ansible_apparmor": {
            "status": "disabled"
        },
        "ansible_architecture": "x86_64",
        "ansible_bios_date": "12/01/2006",
        "ansible_bios_vendor": "innotek GmbH",
        "ansible_bios_version": "VirtualBox",
        "ansible_board_asset_tag": "NA",

(snip)
```

# 参考資料
- 公式ドキュメント 2.9_ja
  - https://docs.ansible.com/ansible/2.9_ja/index.html

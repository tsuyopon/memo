# 概要
RubocopとはRubyの静的解析ツールです。  
ソースコードをruby-style-guideに従って従わせることができます。
- https://github.com/bbatsov/ruby-style-guide

たとえば、
- 無駄なスペースが入力されている
- 無駄な改行が入っている
- この変数1度も使われてないよ
- クラスの中の行数が多すぎる
- 1行の文字数が長すぎる
- "==0"とかの書き方だと.zeroのオブジェクトを使ってねとか

rubocopというコマンドを使うと静的解析を行います。  
エラーとして検出できないように.rubocop.ymlに記述して設定します。

# 簡単な使い方
gemからrubocopをインストールします。最新版だとrubocopだけではエラーになるのでrainbowとその依存バージョンを入れておきます。  
以下は最適化どうかわかっていませんがrainbow-2.0.0を指定してうまくいっています。
```
$ vim Gemfile
gem "rubocop"
gem "rainbow", "2.0.0"
```

rubocopコマンドを対象のrbファイルがあるディレクトリで実行します。
```
$ bundle exec rubocop 
```

### .rubocop.ymlファイル(警告を抑制する設定ファイル)を作成する
次のコマンドを実行すろと.rubocop.ymlファイルの雛形となる.rubocop_todo.ymlを生成してくれます。
```
$ rubocop --auto-gen-config
Inspecting 1 file
.

1 file inspected, no offenses detected
Created .rubocop_todo.yml.
Run `rubocop --config .rubocop_todo.yml`, or add `inherit_from: .rubocop_todo.yml` in a .rubocop.yml file.
```

上記コマンドを実行すると、そのディレクトリ中に.rubocop_todo.ymlが作成されます。  
これを.rubocop.ymlとして配置してrubocopコマンドを実行すると警告が表示されないようになります。  
つまり、この警告をなくすとすべての静的解析にパスしたことになります。

rubocopコマンドを実行しただけだと、.rubocop_todo.ymlは読み込まれません。.rubocop.ymlに名称を変更する必要がある、もしくは.rubocop.ymlから継承する必要があります。  
次のように継承するとrubocopコマンドが実行された場合にも警告を出さないようになりますが、本来は.rubocop_todo.ymlを継承するべきではありません。コードを修正して、PJとして対応不要となるルールを.rubocop.ymlに持っていくというのが正しい運用方法になります。
```
echo 'inherit_from: .rubocop_todo.yml' >> .rubocop.yml
```

対応方法には次の２つがあります。
- 警告を元にコードを修正する
- 警告を許容し、今後警告しないようにする。この場合には.rubocop_todo.ymlを１つ１つ対応していくことになります。

２つは次のようなルールで記述します。.rubocop_todo.ymlで対応しないと決めたルールは.rubocop.ymlに持っていくということになります。
- 「守るべきルール」である.rubocop.yml
- 「今後直すべき違反」である.rubocop_todo.yml

### 一部の違反を自動的に修正する
一部の違反については、-aオプションをつけてrubocopを実行することで、コードが自動的に修正することができます。

### 設定ファイル
設定ファイルrubocop.ymlの説明は以下にあります。
- https://github.com/bbatsov/rubocop/blob/master/config/default.yml

### jenkinsと連携する

実際に試していないですが、Jenkinsであればrubocop-checkstyle_formatterを利用すればJenkinsのViolations pluginにCheckStyle形式でのレポートを読み込ますことができるようです。
- Violations(Jenkinsプラグイン)
 - https://wiki.jenkins-ci.org/display/JENKINS/Violations
- RuboCop Checkstyle Formatter 
 - https://github.com/eitoball/rubocop-checkstyle_formatter

### rubocop.ymlを育てる
次のような流れになりそうです
- .rubocop_todo.yml のコメントを見る
- rubocop の config/default.yml を見る
 - https://github.com/bbatsov/rubocop/blob/master/config/default.yml
- 著名なコーディング規約でどうなっているかを見る
- 自プロダクトがどうあるべきか判断する

### rubocopコマンドのヘルプを見る
```
$ rubocop -h
Usage: rubocop [options] [file1, file2, ...]
    -L, --list-target-files          List all files RuboCop will inspect.
        --except [COP1,COP2,...]     Disable the given cop(s).
        --only [COP1,COP2,...]       Run only the given cop(s).
        --only-guide-cops            Run only cops for rules that link to a
                                     style guide.
    -c, --config FILE                Specify configuration file.
        --auto-gen-config            Generate a configuration file acting as a
                                     TODO list.
        --exclude-limit COUNT        Used together with --auto-gen-config to
                                     set the limit for how many Exclude
                                     properties to generate. Default is 15.
        --force-exclusion            Force excluding files specified in the
                                     configuration `Exclude` even if they are
                                     explicitly passed as arguments.
        --no-offense-counts          Do not include offense counts in configuration
                                     file generated by --auto-gen-config.
    -f, --format FORMATTER           Choose an output formatter. This option
                                     can be specified multiple times to enable
                                     multiple formatters at the same time.
                                       [p]rogress (default)
                                       [s]imple
                                       [c]lang
                                       [d]isabled cops via inline comments
                                       [fu]ubar
                                       [e]macs
                                       [j]son
                                       [h]tml
                                       [fi]les
                                       [o]ffenses
                                       [w]orst
                                       custom formatter class name
    -o, --out FILE                   Write output to a file instead of STDOUT.
                                     This option applies to the previously
                                     specified --format, or the default format
                                     if no format is specified.
    -r, --require FILE               Require Ruby file.
        --fail-level SEVERITY        Minimum severity (A/R/C/W/E/F) for exit
                                     with error code.
        --show-cops [COP1,COP2,...]  Shows the given cops, or all cops by
                                     default, and their configurations for the
                                     current directory.
    -F, --fail-fast                  Inspect files in order of modification
                                     time and stop after the first file
                                     containing offenses.
    -C, --cache FLAG                 Use result caching (FLAG=true) or don't
                                     (FLAG=false), default determined by
                                     configuration parameter AllCops: UseCache.
    -d, --debug                      Display debug info.
    -D, --display-cop-names          Display cop names in offense messages.
    -E, --extra-details              Display extra details in offense messages.
    -S, --display-style-guide        Display style guide URLs in offense messages.
    -R, --rails                      Run extra Rails cops.
    -l, --lint                       Run only lint cops.
    -a, --auto-correct               Auto-correct offenses.
    -n, --[no-]color                 Force color output on or off.
    -v, --version                    Display version.
    -V, --verbose-version            Display verbose version.
    -s, --stdin                      Pipe source from STDIN.
                                     This is useful for editor integration.
```

### rubocopでスタイルを適用する。
このほかにもいろいろなパターンがあるのであくまで参考に載せておきます。
```
# オペレータの前後をいい感じにする。
$ rubocop -a --only Style/SpaceAroundOperators

# インデント崩れを修正する
$ rubocop -a --only Style/IndentationConsistency,\
Style/IndentationWidth,\
Style/MultilineOperationIndentation
```


# TODO
- rubocopのhelpに表示するオプションをひとめぐり

# 参考URL
- rubocop github
 - https://github.com/bbatsov/rubocop
- Rubocop公式ドキュメント
 - http://rubocop.readthedocs.io/en/latest/
- ruby-style-guide
 - https://github.com/bbatsov/ruby-style-guide
- http://kasei-san.hatenablog.com/entry/2015/09/22/091723


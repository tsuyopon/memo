# Cache Digests for HTTP/2
- https://tools.ietf.org/html/draft-ietf-httpbis-cache-digest-04

この仕様はクライアントがキャッシュされたコンテンツをサーバ側に知らせることを許可するHTTP/2フレームタイプを定義しています。
これによって、サーバは何をクライアント側にサーバプッシュとして選択するための情報として利用することができます。


# 解決したい課題
- HTTP/2においてクライアントが現在どのようなキャッシュを保持しているのかをサーバ側に明示的に伝えないと、サーバ側ではどのようなコンテンツをサーバプッシュを利用して送付すればいいのかわからない


# 解決方法
- CACHE_DIGESTフレームを定義して次の仕組みを整備する。また、この仕様書でダイジェスト値の作り方を定義する。
  - キャッシュされたダイジェスト値を送付するための仕組みを提供する。
  - キャッシュされたダイジェスト値をリセットする仕組みを提供する
- クライアントとサーバの設定オプションとして次の値がCACHE_DIGESTを利用する際に最初にやりとりされなければなりません。
  - SETTINGS_SENDING_CACHE_DIGEST: クライアントが送付すべきキャッシュダイジェストが存在するかどうかのフラグが送られる
  - SETTINGS_ACCEPT_CACHE_DIGEST: クライアント側は取得したキャッシュダイジェストを最大限に利用するか、興味がなく捨てるかを明示することができる


# 仕様詳細

## CACHE_DIGESTフレーム定義
HTTP/2でCACHE_DIGESTというフレームを用意する。
```
+-------------------------------+-------------------------------+
|         Origin-Len (16)       | Origin? (\*)                ...
+-------------------------------+-------------------------------+
|                   Digest-Value? (\*)                        ...
+---------------------------------------------------------------+
```

- Origin-Len: Originフィールドのサイズを表す
- Origin: Digest-Valueが適用されるオリジンがASCII文字列として含まれる
- Digest-Value: 計算されたダイジェスト値

HTTP/2パケット構造で規定されるflagsには次の値を示すことができます。(上記のパケットではなくHTTP/2パケットで規定されているflags)
- *RESET* (0x1):
  - これがセットされた場合には、オリジンで保持するキャッシュが不正であるとみなさなければならない。
- *COMPLETE* (0x2): 
  - オリジンは正しいキャッシュされたダイジェストのセットを保持していることを意味する。

## クライアント及びサーバの振る舞い

### クライアントの振る舞い
- CACHE_DIGESTフレームがstream 0でクライアントからサーバへ送付されなければならない。指示されたオリジンにクライアントキャッシュのコンテンツのダイジェストを伝える

### サーバの振る舞い
典型的な使用例として、サーバはコネクションから受け取ったCACHE_DIGESTsを要求するでしょう。

- もし、与えられたURLが現在のCACHE_DIGESとマッチしたら、完全なレスポンスをプッシュすることは不要かもしれない。サーバはクライアントのコンテンツが変わっていないことを示すために304レスポンスを送るかもしれません。
- もし、与えられたURLがどんなCACHE_DIGESTにもマッチしなかったら、クライアントはキャッシュされたコピーを保持していないことを意味するので、完全なレスポンスがプッシュされることになります。

サーバはRESETフラグが指定されない限り、オリジンから送られてきたすべてのCACHE_DIGESTsを使うかもしれません。
RESETフラグが付与されたCACHE_DIGESTフレームを受け取ったオリジンサーバは、以前キャッシュされたコンテンツをクリアしなければなりません。
サーバは空のDigest-ValueをRESETフラグとして扱わなければなりません。

クライアントは接続のしている間にCACHE_DIGESTの更新を率先して送ってくるとは考えにくいので、サーバがキャッシュされたレスポンスが同一コネクションで以前に送付されたかどうかということをトラックすることが期待される。

サーバはCACHE_DIGESTがstream 0以外で送付されてきたら無視しなければなりません。

## パラメータ

### SETTINGS_SENDING_CACHE_DIGEST SETTINGSパラメータ
クライアントはSETTINGS_SENDING_CACHE_DIGEST SETTINGSパラメータを送付することによってCACHE_DIGESTフレームのサポートを知らせるべきである。

このパラメータは値によって次の意味を表す。
- DIGEST_PENDING (0x1): 
  - クライアントは送付すべきダイジェストを持っているときにこれがセットされる。そして、サーバはサーバプッシュを決断するためにダイジェストの到着を待つかもしれない。
- zero(0x00):
  - この値の場合にはクライアントはサーバに送付するダイジェストを持っていないことを意味します。


### SETTINGS_ACCEPT_CACHE_DIGEST SETTINGSパラメータ
サーバはSETTINGS_ACCEPT_CACHE_DIGEST SETTINGSパラメータを送付することによってCACHE_DIGESTフレームをサポートしていることを伝えることができる。サーバは最適化するならばこのパラメータはコネクションを確立した直後に送付するべきである。

SETTINGS_ACCEPT_CACHE_DIGESTパラメータは値によって次の意味を表す。次の意味を表す以外のビットについては無視される
- ACCEPT(0x01): 
  - これがセットされていたらサーバはキャッシュダイジェストのレスポンスを最大限に利用することを明示している。
- zero(0x00): 
  - サーバはCACHE_DIGESTフレームを見ることに興味が無いことを伝える。



# TODO
ダイジェスト値の作成方法などについては全く読めていないのであとで
- https://tools.ietf.org/html/draft-ietf-httpbis-cache-digest-05#section-2.1.1
- https://tools.ietf.org/html/draft-ietf-httpbis-cache-digest-05#section-2.2.1

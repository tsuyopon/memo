# Finding HTTP Alternative Services via the Domain Name Service

# 解決したい課題
- RFC7838でAlt-Svcが定義されていますが、次の２つのタイミングはHTTP通信が開始してからのタイミングとなるので、もっと早い段階での切り替えができないかを模索する。
  - alt-svcレスポンスヘッダをクライアントに応答する
  - HTTP/2でALTSVCフレームを使用する
- 通常だとHTTP接続すると複数回のラウンドトリップが発生してしまうといった課題が存在する。
- また、これ以外にも接続先などをALTSVCのDNSに変更することでユーザープライバシを守るといった意図もあるようだ。


# 解決方法
- DNSによってALTSVCレコードを定義することによって、HTTP通信よりも前の段階でプロトコル変更を検知できるようにします。

たとえば、HTTP通信では次のようなヘッダを送っていたのですが、
```
Alt-Svc: h2=":8000"; ma=60
```

次のようにDNSレコードとして応答できるようになることでそのドメインにはALTSVCによるプロトコル切り替えが可能であること明示することができます。
```
_https._443.www.example.com. 60S IN ALTSVC "h2=\":8000\""
```

クライアントはA/AAAAレコードをDNSサーバに取得する際にALTSVCレコードも問い合わせることで、早期のエンドポイント・プロトコル切り替えが可能になります。


また、ユーザープライバシを守る方法についてはDOHによる実装を提案しています。

# 詳細

### 仕様概要
レコードは次のようにscheme, port, domainを組み合わせたものでALTSVC RR(Resource Record)として定義します。 schemeとportは"_"で結合します。
```
_https._443.www.example.com.
```

以下はAlt-Svcの場合とDNSによるALTSVCの場合のサンプルです。
```
HTTPヘッダの場合
      Alt-Svc: h2=":8000"; ma=60

DNSの場合
      _https._443.www.example.com. 60S IN ALTSVC "h2=\":8000\"" 
```

### SVRレコードタイプとの違い
SVRレコードもALTSVCと似たようにクライアントにサービスのための別のロケーションを知らせるといった役割があるが、次のいくつかの点で大きく異なる。
- SVRレコードは義務である。クライアントはAlt-Svcを最大限利用することなく正しく機能しようとする。
- SVRレコードはクライアントにプロトコルをスイッチしたり、アップグレードしたりを指示することができない。一方でAlt-SvcだとHTTP/2へアップグレードさせることも可能
- SVRレコードは拡張できないが、Alt-Svcは新パラメータの拡張などができる


### HTTP上で送付されるAlt-Svcとの違い
基本的にはDNSのALTSVCもHTTPのAlt-Svcも同じではあるが、次の点で違いある
- DNSではmaではなくDNS TTLとして実装することでmaの代替となる。
- DNSのALTSVC(このドラフト)はコネクションレイテンシ削減とユーザプライバシの改善を目的としている。サーバはTLS1.3とOCSP Staplingで実装されるべき
- DNSの場合だと地域やネットワーク制約によってTTLを変更される可能性がある、DNSサーバオペレータは期限切れ時間に頼ってはならない。

### クライアントの振る舞い
- クライアントがAlt-Svcキャッシュを保持していた場合、クライアントはALTSVC DNSクエリを発行すべきではない。そのまま、そのキャッシュされた値を使って、代替サービスへと接続進めるべきです。もし、キャッシュが切れていたら、クライアントはALTSVCをリフレッシュするかもしれません。

- クライアントはALTSVCレコードの場合には次の実装を行います
  - 1. A/AAAAに関するクエリを発行し、即座に続いてALTSVCクエリを発行します
  - 2. ALTSVCを最初に受け取った場合、alt-svcコネクションを薦めます。そして、もはやアドレスレスポンスが無関係であればそれらを無視します。
  - 3. オリジンサーバへのコネクションをイニシエートする
  - 4. Alt-Svcフィールドを受け取るとすぐに、Alt-Svcを開始します。もし、Alt-Svcあとで他から受け取ったとしてもこのコネクションを停止してはならない。
- もしも、ALTSVCとアドレスクエリの戻りがほとんど同時だった場合、このプロセスは典型的にAlt-Svcを使った新規接続における3RTTを節約することができます。
- もし、クライアントがHTTPとDNSの両方のAlt-Svcをキャッシュしていた場合、HTTPから取得したほうを好みます。
- クライアントがプライバシのための最適化をしたい場合には次のドラフト+DOH(DNS Queries Over HTTPS)で実装しなければならない。
  - https://tools.ietf.org/html/draft-bishop-httpbis-sni-altsvc-01
  - そして、次の処理を実装する必要があります。
  - 1. ALTSVC DNSフィールドを発行する。即座に続いてアドレスクエリを発行する
  - 2. ALTSVCレコードのレスポンスを待つ
  - 3. レスポンスが空じゃなかったら、alt-svcコネクションを進める。そして、アドレスクエリ応答を無視する。
  - 4. さもなければ、アドレスクエリの応答を待って、そして通常どおりコネクトする。


# 参考URL
- https://tools.ietf.org/html/draft-schwartz-httpbis-dns-alt-svc-01
- DNS ALTSVC recordの提案仕様
  - https://asnokaze.hatenablog.com/entry/2018/01/17/090213

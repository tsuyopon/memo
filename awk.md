# 概要
AWKの使い方について

# 詳細
### AWKの簡単な使用法
たとえば、/etc/passwdからユーザーネームだけを取り出したい場合
```
   $awk -F" " '{print $1}' /etc/passwd
```
のようにすればよい。
""の間は区切り文字を表している。$1などはperlなどと同様1番目のカテゴリである

### awkの組み込み変数
```
NF   現在の入力行のフィールド数
NR   現在の入力行の行番号
FS   フィールドの区切り文字(値を変更すると区切り文字が変更される) 
```

### スクリプトを利用する。 
-fオプションの後にファイル名を指定すればよい。
```
$ awk -f <file>
```

### awk使用例
- hostsからエイリアス名を取り出す。
```
$ awk 'NF==3{print $3}' hosts
```

- passwdから「(5番目のカラム):(1番目のカラム)」という表示で取り出せ。
```
$ awk -F":" '{print $5 ":" $1}' passwd
```

- passwdから各行の3番目のカラム(uid)と4番目のカラム(gid)を合計して表示する。
```
$ awk -F":" '{print $3 + $4}' passwd
```

- passwdから全て行の3番目のカラムと4番目のカラムを合計して表示する。
BEGIN処理としてCaluculateという文字を表示させる。 END処理として結果の表示を行う。
```
$ awk -F":" 'BEGIN{print "Caluculate"} {t += $3 + $4} END{print t}' passwd
```

- passwdから3番目と4番目の値が等しい場合にその行を表示させる。
```
$ awk -F":" '{print $3 == $4}' passwd
```

- passwdの3番目のカラムが100以上ならばその行を表示させる。
```
$ awk -F":" '{ if($3 >= 100){ print $0 } }' passwd
```

- protocolのファイルでスペースかタブをフィールドセパレタとして、その行ごとに対するフィールド数を表示させる。また、END処理として行の合計を「ファイル名=行数」で
表示させる。
```
$ awk '{print NF} END{print FILENAME "=" NF}' protocol
```

- passwdの20行目から30行目までを取り出せ。
```
$ awk 'NR==20, NR==30' passwd
```

- passwdを1、5、6、7番目のカラムを取り出せ。フィールドセパレータとして-----を使用する。
```
$ awk -F":" 'BEGIN{ OFS="-----"} {print $1,$5,$6,$7}' passwd
```

- 「From:」で始まる行を標準入力から抜き出すには次のようにします。
```
$ awk '/^From:/' filename
```

- passwdから10行目の入力行だけを表示したい場合 これには、読み込んだ行数を表す組込み変数である「NR」を使用する。 
```
$ awk 'NR==10' passwd
```

### sakilaテーブルで試す 
練習用にsakilaから取得して利用します
```
mysql -u root -p --protocol=tcp -N sakila -e "SELECT * FROM payment;" > log
```

- 行のどこかに16000という値が入っていたら表示する
```
$ cat log | awk -F'\t' '{ if( /16000/ ){ print $0} }'
1939	71	1	16000	0.99	2005-08-23 20:44:36	2006-02-16 07:12:48
16000	597	1	11240	2.99	2005-08-02 13:28:30	2006-02-16 07:24:01
```

- 行の先頭に含まれていたら表示する
```
$ cat log | awk -F'\t' '{ if( /^1600[1-2]/ ){ print $0} }'
16001	597	1	11880	5.99	2005-08-17 14:28:28	2006-02-16 07:24:01
16002	597	1	12081	4.99	2005-08-17 22:10:46	2006-02-16 07:24:02
```

- 特定のフィールドにある文字が含まれていたら表示する
```
$ cat log | awk -F'\t' '{ if( $4 ~ /^1600[1-2]/ ){ print $0} }'
1992	73	2	16002	2.99	2005-08-23 20:47:12	2006-02-16 07:12:49
2931	108	1	16001	2.99	2005-08-23 20:45:53	2006-02-16 07:13:04
```

```
$ cat log | awk -F'\t' '{ if( $1 == 16041){ print $2} }'
```

### 行頭に時刻を表示する
以下はvmstatを10秒ごとに出力するサンプルですが、先頭に時刻を付与しています。
```
$ vmstat 10 | awk '{print strftime("%F %T ") $0}'
2017-12-01 21:50:30 procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
2017-12-01 21:50:30  r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
2017-12-01 21:50:30  2  0   4696 122112    532 782484    0    0    49   177   41   43  0  0 99  0  0
2017-12-01 21:50:40  0  0   4696 122112    532 782484    0    0     0     0   45   48  0  0 100  0  0
2017-12-01 21:50:50  1  0   4696 122112    532 782484    0    0     0     2   46   49  0  0 100  0  0
```

たとえば、ログの加工の場合などに利用することができそうです
```
$ echo "123456789,field3,field4,field5" | awk -F',' '{print strftime("%c", $1), $0}'
1973年11月30日 06時33分09秒 123456789,field3,field4,field5
```

### awkスクリプトをperlへと変換する
- a2pコマンドを利用する。

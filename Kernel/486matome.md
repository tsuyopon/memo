


# Chapter1


### 3つの動作モードについて
486は以下の３つのモードを持っています。
* リアルモード
	* MS-DOS用アプリケーション実行
* プロテクトモード
	* Windows用アプリケーションの実行
* 仮想8086モード
	* MS-DOS用アプリケーションの実行
	* プロテクトモードでも従来のリアルモードを使えるように設けられた動作モード


### 486の主要機能について
- セグメント機能
- 保護機能
- タスク機能
- 32ビットサポート
- ページング
- 仮想8086モード
- キャッシュメモリ
- 浮動小数点演算機構

# Charpter2

### キャッシュメモリ
486には8Kバイトのキャッシュメモリが内蔵されています。  
486ではライトスルー方式をとっています。
* ライトスルー方式
	* キャッシュメモリに書き込むと同時に本来のメモリにも書き込みを行う
* ライトバック方式
	* キャッシュメモリに書き込んだ時点でCPUは次の処理に進み、本来のメモリへの書き込みはその後の別のタイミングで行う

### 486レジスタについて
* 一般レジスタ群
	* 汎用レジスタ: EAX, EBX, ECX, EDX, ESI, EDI
	* ベースポインタ: EBP
	* スタックポインタ: ESP
	* インストラクションポインタ: EIP
	* フラグレジスタ: EFLAGS
	* セグメントレジスタ: CS, DS, ES, SS, FS, GS
* 浮動小数点レジスタ群
* デバッグレジスタ群
	* デバッグレジスタ: DR0, DR1, DR2, DR3, DR4, DR5, DR6, DR7
	* テストレジスタ: TR3, TR4, TR5, TR6, TR7
* システムレジスタ群
	* システムアドレスレジスタ: GDTR, IDTR, LDTR, TR
	* コントロールレジスタ: CR0, CR1, CR2, CR3

### アドレスバス

* アドレスバス(32本:一方行)
	* 4Gバイトのメモリ空間から任意の1, 2, 4byteを選択するための32bitのアドレスデータ、および任意のI/Oポートを選択するためのアドレスデータが通るバス
* I/Oアドレスバス(16本:一方行)
	* アドレスバスのA0-A15の下位16本(ビット)が接続されています
* データバス(32本:双方向)
	* メモリにリード・ライトするデータ、および入出力ポートから入出力するデータが通る


# Charpter3

### メモリ管理機能

##### メモリ割当
オペレーティングシステムが使用する領域とアプリケーションが使用する領域が分かれます。
* システム領域
	* オペレーティングシステムが使用する領域
* ユーザー領域
	* アプリケーションが使用する領域

##### メモリ保護
他のプロセスが別のプロセスのメモリ領域への書き込みなどを防ぐことができます。  
MS-DOSの場合にはこのような保護機能はないようです。

##### アドレス変換
見かけ上の番号と実際の番号を変換することをアドレス変換といい、この仕組みを使ってタスク切替えを行って、他のプロセスにアクセスできないという保護機能の役割も担っている。
このアドレス変換の仕組みはMMUを使って成り立っています。

##### MMUについて
* MMU(Memory Management Unit: メモリ管理ユニット)
	* メモリ管理のための特殊機能をもったハードウェアで、486はCPUチップ内にMMUを内蔵している。
	* OSがメモリ割当時に変換表を作成してMMUに設定しておくと、そのアドレス変換表に従ってアドレスを変換する役割を持っています。

論理アドレスと物理アドレスの対応を設定した状態のことを「メモリマッピング」と呼びます。  
イメージ的には以下のようにタスクごとに同じアドレスの論理アドレスが生成されているが、実際にアクセスすると物理アドレスが異なるイメージです。
* タスクA
	* 0100にアクセスすると実メモリ上の10100にアクセスされる
* タスクB
	* 0100にアクセスすると実メモリ上の20100にアクセスされる

MMUのメリット
* タスクのアドレス空間を常に連続した領域に見せかけることができます。
* 仮想記憶という仕組みを使うと搭載メモリ容量よりも多くのメモリがあるかのように見せかける機能を使うことができる。
	* あまり使われていないデータをハードディスク上のSWAP領域などに移動させることによって実現している。

### 特権レベル
オペレーティングシステムでは以下の２つの概念を持っています。   
これによってオペレーティングシステムの安全性を担保しています。
* 特権状態
	* 特殊命令やI/Oポートのアクセスを実行できる
* 一般状態
	* アプリケーションソフトウェアを実行できる

# Chapter4

### CR0: コントロールレジスタ0について
コントロールレジスタは32bit幅のレジスタです。

CR0の最下位ビット(32bit目)はPE(プロテクションイネーブル)とよばれていて、1か0で下記機能となります。
* CR0のPEが1の場合
	* CPUの動作モードがプロテクトモードに切り替わる
* CR0のPEが0の場合
	* CPU動作モードがリアルモードに切り替わる


### プロテクトモードへの移行の流れ

1. セグメント設定
	1. グローバルディスクリプタテーブル(GDT)作成
	1. GDTR設定
1. 割り込み設定
	1. 割り込みディスクリプタテーブル(ITD)作成
	1. IDTR設定
1. アドレス制限の解除
	1. アドレスバスA20ビットのマスク解除
1. プロテクトモードへの移行
	1. CR0のPEビットをセット
	1. セグメントレジスタ再設定

### リアルモードへの移行の流れ

1. 割り込み設定
	1. IDTR設定
1. セグメント設定
	1. グローバルディスクリプタキャッシュの再設定
1. リアルモードへの移行
	1. CR0のPEビットを0にリセット
	1. セグメントレジスタ再設定
1. アドレス制限の解除
	1. アドレスバスA20ビットのマスク設定

# 参考資料
* 各種レジスタ(コントロールレジスタ、ステータスレジスタなど)について詳細に記述されているのでリファレンスとしてすごいいい
	* [http://caspar.hazymoon.jp/OpenBSD/annex/intel_arc.html]





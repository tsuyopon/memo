# 概要
データリンク層については次の２つにわかれている

- LLC(Logical Link Control)副層
  - L2でネットワーク層に近い
  - 下位層に依存しない制御を行なう。IEEE802.2によって定められている。
- MAC(Media Access Control)副層
  - L2で物理層に近く、衝突の問題を解決する

また、L2機器として知られるブリッジとスイッチや転送方式についてもまとめる。
L2にはCiscoのSPT(Spanning-Tree-Protocol)

# 詳細
### OSIモデルとIEEE規格
OSIモデルでは単純にL1, L2(LLC), L2(MAC)と分離されていますが、実際にはどのようなレイヤ構成となっているでしょうか。
IEEE規格にOSIモデルを当てはめて確認します。
- イーサネット(L1+L2LLC+L2MAC)
- IEEE802.2(L2LLC) + イーサネット(10Base-T等)/IEEE802.3(L1+L2MAC)
- IEEE802.2(L2LLC) + トークンリンク/IEEE802.5(L1+L2MAC)
- IEEE802.2(L2LLC) + FDDI(L1+L2MAC)
- IEEE802.2(L2LLC) + 無線LAN/IEEE802.11(L1+LMAC)
- IEEE802.2(L2LLC) + CATV/IEEE802.14(L1+LMAC)
- IEEE802.2(L2LLC) + WiMAX/IEEE802.16(L1+LMAC)
- IEEE802.2(L2LLC) + WiMAX/IEEE802.16(L1+LMAC)

実はMAC副層の上の層にはIEEE802.1ブリッジングというものが上記の間に存在する。(ここでは省略)

### MACアドレスとは
NICにつけられた固有の識別子でROMに焼き付けられており、イーサネットの場合には48bit(先頭24bitは製造元)で表します。
MACアドレスはなぜ必要となるのか?それには次のような問題があるからです。
- IPアドレスだけだったら、PC-AとPC-Bの間に挟まれたルーターがどのようにして自分が処理するべきパケットと認識できない
- ハブだったらデータは全PCに伝わってしまって、自分宛のデータ化どうかわからない
- スイッチだったら宛先を見て適切なポートだけに転送したいが、誰あてのデータかわからない。

レイヤ2のブロードキャストアドレスはFF:FF:FF:FF:FF:FFといったアドレスとなる。主にサービス発見、経路探索、サービス通知で利用される。

### 決定的プロトコルと非決定的プロトコル
- 決定的プロトコル
  - 一定時間たてば必ず発言チャンスがやってくる
  - 衝突(同時データ送信)は発生しない
  - 無駄な待ちが発生することがある
  - 代表的なプロトコルとしてはトークンリングやFDDI
- 非決定的プロトコル
  - 周囲が黙っているときに最初に発言した人が最後まで話せる
  - ほぼ同時に発言してしまったら、適当な時間後(乱数)に再度発言する
  - 早いもの勝ちで送信することができ、データが衝突することもあるが、無駄な待ちを小さくすることができる。
  - 代表的なプロトコルとしてはCSMA/CDがある

### CSMA/CD処理詳細
次の順番で処理が行われる。
- 1. ホストが送信を要求
- 2. キャリアの探知
- 3. フレームの構成
- 4. 送信開始
- 5. 衝突検出(衝突を検出したと仮定。衝突検出しなければ、そのまま送信を継続)
- 6. ジャム信号の一斉通報
- 7. 試行回数が試行回数+1
- 8. コリジョンの数が試行回数よりも少ない
- 9. 多数のコリジョンがあると送信の打ち切りを行う

なお、コリジョンの試行回数より少なくなければ、アルゴリズムがバックオフを計算してマイクロ秒待機する。

- 参考資料
  - http://www.oit.ac.jp/elc/~kumamoto/data/05.pdf


### コリジョンの種類
コリジョンには衝突が起こったビットの位置、またコリジョンの発生した場所によって種類が分かれる。
- ローカル
  - Txで送信中にRxで受信
- リモート
  - リピータ接続の対抗側で発生したコリジョン
- レイト
  - フレームの64オクテット以降でコリジョン。NICは再送信しない

### イーサネットのエラー種類
- コリジョン
  - スロット時間が経過する前に発生した同時伝送
- ラント
  - 64B未満の不正なフレーム
- レイトコリジョン
  - スロット時間が経過した後に起きた同時伝送
- 超過送信、長いフレーム、レンジエラー
  - 過剰または不正に長い伝送
- 短いフレーム、コリジョンフラグメント
  - 不正に短い伝送
- FCSエラー
  - 破損フレームの伝送
- アラインメントエラー
  - 伝送されたビット数の過不足
- レンジエラー
  - フレーム内のオクテット数が実際の数と報告された数で一致していない
- ゴーストまたは超過送信
  - 不自然に長いプリアンブルまたはジャムイベント


### オートネゴシエーション
イーサネットには10Mbpsから10Gbpsまで様々な速度があるので、速度を自動的に認識させる機能(オートネゴシエーション)があります。
例えば、次の上から順番で優先順位となる。
```
1000BASE-T 全二重
1000BASE-T 半二重
100BASE-TX 全二重
100BASE-TX 半二重
10BASE-T 全二重
10BASE-T 半二重
```

### ブリッジ
ブリッジは2以上のネットワークを接続して、宛先MACアドレスをもとにして転送判断を行う。ポート番号と宛先MACアドレスに関するテーブルを保持する。
- 衝突ドメインを分割して衝突の可能性を減少させる
- セグメント間での通信が多い場合、スループットを減少させる
- ブロードキャストはフィルタリングしない

### スイッチの動作
- 宛先MACアドレスから、アドレステーブルを参照してデータ転送を判断する(ブリッジと同じ)
- 複数の衝突ドメインが存在する
- 専用セグメントを作成することができる(マイクロセグメンテーション)

### ブリッジとスイッチの相違点
ブリッジとスイッチ共にMACアドレスで転送を判断ということは同じだが何がちがうのだろうか? 表を元にして確認してみる。  
リピーターやハブで延長してもフィルタリングは出来ない。つまり、衝突ドメインが大きくなる一方となる。これがブリッジ・スイッチとの大きな違いとなる。

| | ブリッジ | スイッチ |
|:------------:|:------------:|:------------:|
| 動作 | ソフトウェア | ハードウェア |
| ネットワークの接続 | 同一帯域同士のみ | 異なる帯域同士も可能 |
| 転送方式 | ストア＆フォワードのみ | カットスルー、ストア&フォワード |
| セグメント化 | 単純ネットワーク分割 | 仮想回路 |

### ブリッジとスイッチオン転送方式
- カットスルー方式
  - 宛先MACアドレスのみをチェックする
  - 低遅延だがエラーフレームも転送される
- ストア＆フォワード
  - フレーム全体のエラーチェックを行う。
  - 高遅延でエラーフレームはカットされる
- フラグメントフリー
  - 64byte読み込んだ時点で転送を始める


表で整理すると次の通り

| 転送方式 | メモリに読み込む量 | エラーの転送 |
|:------------:|:------------:|:------------:|
| カットスルー | 同一帯域同士のみ | 異なる帯域同士も可能 |
| ストア＆フォワード | 全フレーム| ハードウェア |
| フラグメントフリー| ストア＆フォワードのみ | カットスルー、ストア&フォワード |


読み込む位置は次の通りです。()内はバイト数を表します。
```
| 宛先MAC(6) | 送信元MAC(6) | 長さ/type(2) | データ(46〜1500)     | FCS(4) |
             ^                                ^                            ^
             カットスルー                     フラグメントフリー           ストア＆フォワード
```

### 衝突ドメインとブロードキャストドメイン
衝突ドメインの数やブロードキャストドメインの数はセグメントを作成する上で重要となる。

| | 衝突ドメイン分割 | ブロードキャストドメイン分割 | アドレス | 機器 |
|:------------:|:------------:|:------------:|:------------:|:------------:|
| ネットワーク層 | 可 | 可 | IPアドレス・MACアドレス | ルーター |
| データリンク層 | 可 | 不可 | MACアドレス | ブリッジ、スイッチ |
| 物理層 | 不可 | 不可 | | リピーター、ハブ |

### STP(Spanning Tree Protocol)
スパニングツリープロトコルはIEEE802.1dで定義されています。
このプロトコルは
- 冗長構成になっているスイッチドネットワークにおいて、ブロードキャストストームなどのループによる問題を回避するためのプロトコル

たとえば、3つのスイッチをそれぞれで指しているとどのループが起きていることを検出して、特定のポートを使わないようにさせたりすることができます。

# 動作
- 1. STPはBPDU(Bridge Protocol Data Units)というフレームをスイッチ間で送受信して設定で優先度の高く設定されたスイッチをルートブリッジに決めます。
  - このフレームを2秒ごとに交換します。
    - BPDUには8バイトのブリッジID（プライオリティ2バイト＋MACアドレス6バイト）、「パスコスト」などの情報が含まれます。
	- 2. BPDUのやり取りの中でループを検出し、どちらのインターフェースがルートブリッジにとって最短かを判断し、フレームを転送するフォワーディング、転送しな>いブロッキングというインターフェースを決めます。

	# 参考URL 
	- wikipedia
	  - https://ja.wikipedia.org/wiki/%E3%82%B9%E3%83%91%E3%83%8B%E3%83%B3%E3%82%B0%E3%83%84%E3%83%AA%E3%83%BC%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB




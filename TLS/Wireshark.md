# 概要
TLSに関するwiresharkについて(../wireshrk.mdも参考のこと)

# 詳細

### ハンドシェイクを追跡する
例えば、https://www.yahoo.co.jpのハンドシェイクwiresharkで追跡する場合
- 1. パケットをキャプチャする。この時には様々な他のデータも取得される。
- 2. プロトコルでソートをかけて、"Protocol"タブでソートをかけた後に"Info"タブでソートをかけると「Client Hello」が並ぶことになる。
- 3. 選択したパケットから「Extension: server_name」の「Server Name Indication extension」の中のServer Nameにサーバ名前があるのでここをクリックする。
- 4. パケット一覧を再度クリックして、そのまま上矢印や下矢印で前や次のパケットに移動すると「Server Name」もそのパケットのものに切り替わるので容易に探したい「www.yahoo.co.jp」を探すことができる。
- 5. 続いて、そのパケットを選択して右クリックして「Follow」-> 「TCP Stream」を選択する
- 6. そのパケットをクリックした状態において「No.」タブをクリックしてソートすると、該当のパケットに関する情報が並んで整列されることになる。

### 秘密鍵を登録する
wiresharkでは秘密鍵をあらかじめ登録しておくことによってTLS通信の中身を確認することができるようになります。
- 1. wiresharkを開く
- 2. 「Preference」-> 左側タブから「Protocols」の中の「SSL」をクリックする
- 3. SSLの設定画面から秘密鍵を登録します

### 「Follow SSL Stream」を利用する
Wiresharkで便利な機能の１つに「Follow TCP Stream」がありますが、秘密鍵を登録することによって「Follow SSL Stream」で流れを追うことができるようになります。

- SeeAlso
  - http://d.hatena.ne.jp/ozuma/20140413/1397397632


# TLS1.3関連
keylogfileで一時鍵であるセッションシークレットを落とすことができる。
```
$ echo q | /usr/local/openssl-1.1.1a/bin/openssl s_client -connect localhost:443 -keylogfile /Users/tsuyoshi/Desktop/tls_key.log -tls1_3
$ cat /Users/tsuyoshi/Desktop/tls_key.log
# SSL/TLS secrets log file, generated by OpenSSL
SERVER_HANDSHAKE_TRAFFIC_SECRET 29340de46cab0d80a56b704cc2768fe9c1c6e2d54ed37a147f6c7fe2c9d3e165 815061786d9bb7b5826061eb0f6439b152c6376cbe79292a2cf7b95e3bc1bc9a
EXPORTER_SECRET 29340de46cab0d80a56b704cc2768fe9c1c6e2d54ed37a147f6c7fe2c9d3e165 2b73db314f39d688623549b9bb5b73d77604f36097513fbbfe54ca95b2fe22b3
SERVER_TRAFFIC_SECRET_0 29340de46cab0d80a56b704cc2768fe9c1c6e2d54ed37a147f6c7fe2c9d3e165 f15197501588457ae0e3aea67d165474eb3262114b8d0ff7bea0390afb01ae29
CLIENT_HANDSHAKE_TRAFFIC_SECRET 29340de46cab0d80a56b704cc2768fe9c1c6e2d54ed37a147f6c7fe2c9d3e165 aeb19f244c3ef612a6331a2d89d3fb9552b0f063710ead1190e100d70f7c5dde
CLIENT_TRAFFIC_SECRET_0 29340de46cab0d80a56b704cc2768fe9c1c6e2d54ed37a147f6c7fe2c9d3e165 5d203b8c1f445f26af6d92394cc68f0360b7718b810fc7f34478a965dfdf1aa4
```

tsharkで確認する場合にはotls.keylog_fileを指定する。
```
$ sudo tshark -otls.keylog_file:/Users/tsuyoshi/Desktop/tls_key.log -dtcp.port==443,tls -Y tls
Capturing on 'Wi-Fi: en0'
   51  11.128124 192.168.3.10 → 31.13.91.4   TLSv1 312 Client Hello
   53  11.474012   31.13.91.4 → 192.168.3.10 TLSv1.3 1464 Server Hello, Change Cipher Spec, Encrypted Extensions
   54  11.474120   31.13.91.4 → 192.168.3.10 TLSv1.3 1464 Encrypted Handshake Message [TCP segment of a reassembled PDU]
   55  11.474126   31.13.91.4 → 192.168.3.10 TLSv1.3 255 Encrypted Handshake Message
   58  11.485966 192.168.3.10 → 31.13.91.4   TLSv1.3 130 Change Cipher Spec, Finished
   59  11.487166 192.168.3.10 → 31.13.91.4   TLSv1.3 114 Application Data, Alert (Level: Warning, Description: Close Notify)
   60  11.903787   31.13.91.4 → 192.168.3.10 TLSv1.3 241 Application Data
   61  11.903901   31.13.91.4 → 192.168.3.10 TLSv1.3 90 Application Data
```

wiresharkでもPreference -> Protocolタブ -> TLS を選択してから"(Pre)-Master-Secret log filename" へに"/Users/tsuyoshi/Desktop/tls_key.log"を指定して取得した場合には「Decrypted SSL」といたタブをクリックすることで確認することができそう。
ただし、平文としてのデータをパースまではしてくれてないようなので注意。
- https://www.comparitech.com/net-admin/decrypt-ssl-with-wireshark/




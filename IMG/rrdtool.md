# 概要
RRD(Round Robin Database)Toolはグラフを描画する為のツールです。 尚、このツールはMRTGと同じ作者が開発しているツールです。

以下にRRD(ラウンドロビンデータベース)について説明します。
- ラウンドロビンデータベースとは、予め扱うデータ数が決められているものです。
- 新しいデータを追加する際には古いデータを順次上書きして保存するようなデータベースです。
- どれだけのデータを残しておくのかを予め決定してから、データベースを利用するのでデータサイズを気にする必要がありません。

以下にRRDtoolの特徴を示します。
- 柔軟なグラフ描画
- 高速なデータ処理
- データを収集する機能は持たない(これによりスクリプトやツールが必要となる)

グラフ作成までの流れを示します。グラフ作成では、以下の作業は全て必須です。
- ラウンドロビンデータベースの作成（利用開始時のみ）
- ラウンドロビンデータベースの更新（定期的に）
- グラフ描画（必要に応じて）

# 詳細

### rrdtoolコマンドの概要
rrdtoolのコマンドの書式は次の通り
```
$ rrdtool [option] command command_options
```

コマンドは以下のものが存在する。
```
create, update, updatev, graph, dump, restore, last, first, info, fetch, tune, resize, xport
```

以下に代表的なものを取り上げる。
- create:    RRDデータの入れ物を作成する。
- update:    取得したデータをデータベースに保存する
- graph:     グラフ画像を出力する


## グラフ作成操作

### ラウンドロビンデータベースの作成について(利用開始時のみ行う)
以下にrrdtoolコマンドは、traffic.rrdというラウンドロビンデータベースに値を格納する実行例です。
traffic.rrdは、実行した時のカレントディレクトリ内に作成されます。
以下の例では、in,outというデータソース(DS)名でそれぞれ受信データ量、送信データ量 が格納されることを、最終的にグラフは日間、週間、月間、年間の4種類を作成します。
```
------------------------------------------------------------------------------
# rrdtool create traffic.rrd \ 
--start 1088481600 \         # データ取得開始時間の指定（default 現在時刻）
--step 300 \                 # データを格納する時間の間隔の指定（default 300s）
DS:in:COUNTER:600:U:U \      # データソースの定義
DS:out:COUNTER:600:U:U \     # データソースの定義
RRA:AVERAGE:0.5:1:600 \      # ラウンドロビンアーカイブの定義（一日グラフ用）
RRA:AVERAGE:0.5:6:700 \      # ラウンドロビンアーカイブの定義（週間グラフ用）
RRA:AVERAGE:0.5:24:775 \     # ラウンドロビンアーカイブの定義（月間グラフ用）
RRA:AVERAGE:0.5:288:797 \    # ラウンドロビンアーカイブの定義（年間グラフ用）
RRA:MAX:0.5:1:600 \          # ラウンドロビンアーカイブの定義（一日グラフ用）
RRA:MAX:0.5:6:700 \          # ラウンドロビンアーカイブの定義（週間グラフ用）
RRA:MAX:0.5:24:775 \         # ラウンドロビンアーカイブの定義（月間グラフ用）
RRA:MAX:0.5:288:797          # ラウンドロビンアーカイブの定義（年間グラフ用）
------------------------------------------------------------------------------
```
上記で、「DS:」から始まっている行はデータソースの定義はDS:ds-name:DST:heartbeat:min:max というコロン区切りの6つのフィールドからなりたっていることがわかる。 ここでは、6つのフィールドそれぞれを説明する。

- データソース(DS)の書式】
```
------------------------------------------------------------------------------
  [項目]     [説明]
------------------------------------------------------------------------------
  DS         データソースの定義の宣言。 
  ds-name    ラウンドロビンデータベースに格納するデータソースを区別するための名前を指定する。
             上記の例では、受信データ量をin、送信データ量outとしました。 
  DST (Data Source Type)
             取得したデータはそのままラウンドロビンデータベースに格納するのではなく、前回取得
             した値との差分をとったり、データを時間で割った上で格納する。
             データをどう加工するかはここで指定するキーワードによって制御できる。
             選択できるのはGAUGE、COUNTER、DERIVE、ABSOLUTEの4つである。
  heartbeat  データを取得する間隔［秒］
             この値は--stepオプションで指定されるstep値（デフォルト300秒）より、大きい値を
             設定しておく必要がある。 
  min, max   何かが原因で本来獲得するはずのない異常に大きな値、或いは異常に小さな値を無視するため
             に利用する。
             特に設定の必要がなく、取得した値はそのまま利用するのであれば、これらの値に"U"(UNKNOWNの意)
             を設定しておく。 
------------------------------------------------------------------------------
```
上記のDSTは4つのタイプがあるので、次にデータソースタイプ(DST)について説明する。 

- 【データソースタイプの書式】
```
------------------------------------------------------------------------------
  [キーワード]   [説明]
------------------------------------------------------------------------------
  GAUGE          温度やユーザ数など格納するデータがある絶対値を示し、特にデータを
                 加工する必要がない場合に利用。
                 取得したデータはRRAに指定された処理が行なわれた上で、格納される。 
  COUNTER        トラフィック数のように※連続的に増加するような値を扱う場合に指定。
                 取得したデータは毎秒当たりの数値に変換され、RRAに指定された処理が
                 行なわれた上で、格納される。
                 取得するデータはカウンターがあふれる場合以外減らないことが前提条件。
                （カウンターがあふれた場合にはRRDtoolは適切にデータを処理する）。 
  DERIVE         COUNTERと同様に前回取得した値との差分を扱うが、値が減らされることがある場合に利用する。
                 取得したデータは毎秒当たりの数値に変換され、RRAに指定された処理が行なわれた上で、格納される。
                 COUNTERと異なりオーバーフローのチェックは働かない。 
  ABSOLUTE       COUNTERと同様に連続的に増加するような値を扱うが、データ取得のたびに必ずカウンターが0
                 にリセットされる場合に利用する。
                 取得したデータは毎秒当たりの数値に変換され、RRAに指定された処理が行なわれた上で、格納される。 
------------------------------------------------------------------------------
```

- 【ラウンドロビンアーカイブの定義】
```
------------------------------------------------------------------------------
  [項目]   [説明]
------------------------------------------------------------------------------
  RRA      ラウンドロビンアーカイブの定義の宣言。 
  CF       結合関数を指定する。
           指定可能なのはAVERAGE（平均値）, MIN（最小値）, MAX（最大値）, LAST（最終値） の４つ。 
  xff      取得したデータのうち、UNKNOWNであるデータを許可する割合を指定する。
           何らかの原因でデータ更新に失敗すると、そのときに取得した各データは" UNKNOWN"に設定される。
           但し、個々のデータがUNKNOWNになることは起こっても作成されるグラフが乱れることを防ぐため、
           RRDtoolではUNKNOWNであるデータの割合がxffで指定した値より小さければ、他の取得データから、
           値を予測・補完して扱う。
           例えば、５回の計測した内の2つUNKNOWNになっていた場合、xffが0.5であれば、UNKNOWNの値を他の
           データから補完するが、xffが0.2であれば補完はされず、UNKNOWNとなる。 
  steps    ここで指定されるデータ数を母集団として、上記の結合関数（CF）における平均値などを算出する。 
  rows     何世代分のデータを格納しておくかを指定する。 
```


### グラフ描画に関するrrdtoolコマンドのオプションについて
たとえば、次のような感じで様々なオプションを指定してグラフを作成することができます。
```
# rrdtool graph \                               # graphを指定していることに注意
traffic.png \                                   # ファイル名指定
--imgformat=PNG \                               # 画像フォーマットの種類の指定
--start=-86400 \                                # グラフ化するデータ範囲[秒]
--end=-300 \                                    # 　　　　　〃
--base=1000 \                                   # 基数
--height=120 \                                  # グラフの高さ
--width=500 \                                   # グラフの幅
--title="トラフィック 一日データ ５分平均" \    # (1)グラフのタイトル
--vertical-label="bytes per second" \           # (2)縦軸のラベル
DEF:a="/path/to/rrd":in:AVERAGE \               # データソースの指定（データ１平均値）
DEF:b="/path/to/rrd":out:AVERAGE \              # 　　　〃　　　　　（データ２平均値）
AREA:a#00CF00:"受信"  \                         # (3)(5)グラフ描画及び凡例指定
GPRINT:a:LAST:" 現在\:%8.2lf %S"  \             # ((6)現在値表示
GPRINT:a:AVERAGE:"平均\:%8.2lf %S"  \           # (7)平均値表示
GPRINT:a:MAX:"最大\:%8.2lf %S\n"  \             # (8)最大値表示
LINE1:b#002A97:"送信"  \                        # (4)(3)グラフ描画及び凡例指定
GPRINT:b:LAST:"現在\:%8.2lf %S"  \              # (10)現在値表示
GPRINT:b:AVERAGE:"平均\:%8.2lf %S"  \           # (11)現在値表示
GPRINT:b:MAX:"最大\:%8.2lf %S"                  # (12)現在値表示
```

- graphコマンドのサブオプション
```
------------------------------------------------------------------------------
  [オプション]     [説明]
------------------------------------------------------------------------------
  --imgformat       画像のファイル形式の指定。 
  --start           グラフに利用するデータの始点になる時刻を指定。 
  --end             グラフに利用するデータの終点になる時刻を指定。 
  --title           画像上部に表記するタイトルの指定。 
  --base            基数の指定。1000或いは1024を指定する。トラフィック量の場合は1000を指定するのが普通。 
  --height          グラフのピクセル数の指定（高さ）。デフォルトは。※ 
  --width           グラフのピクセル数の指定（幅）。デフォルトは。※ 
  --vertical-label  縦軸の凡例として利用する文字列の指定。 

※　画像全体のピクセル数ではなく、あくまでグラフのピクセル数。
------------------------------------------------------------------------------
```
上記のコマンドで「DEF:」で始まる行はデータソース名の定義です。 グラフ描画に利用するデータソースに対して任意の名前を与えます。 
つづいて、DEF:vname=rrd:Ds-name:CF の4つのフィールドを記述します。 

- データソース名の定義
```
------------------------------------------------------------------------------
  [オプション]     [説明]
------------------------------------------------------------------------------
  DEF              データソース定義の宣言。 
  vname=rrd        変数名(vname)の定義。
                   データソースを格納したラウンドロビンデータベース(rrd)の
                   データソースを格納する変数名を定義する。 
  Ds-name          データソース名の指定。
                   上記で定義した変数にラウンドロビンデータベースに格納された
                   データソースの内、どの値を利用するのかを指定。 
  CF               結合関数を指定する。
                   AVERAGE、MAX、MIN、LASTのいずれかを指定。 
------------------------------------------------------------------------------
```

- グラフの種類の定義：AREA、LINE[1-3]、STACK
  - RRDtoolでグラフ描画する際、棒グラフにするのか、線グラフにするのかを設定できる。 また、データをそのままグラフに乗せるだけでなく、複数の値を積み上げて表示するのも可能である。 どのようなグラフにするかを定義AREA（棒グラフ）、LINE[1-3]（線グラフ）、STACK（既存のAREA、 或いはLINEに値を上乗せして描画）から選択し、グラフの種類:データソース名:"凡例に使用する文字列" の3フィールドで指定する
```
------------------------------------------------------------------------------
  [フィールド]     [説明]
------------------------------------------------------------------------------
  グラフの種類      AREA（棒グラフ。複数の値を重ねる場合、描画順序に注意が必要）
                    LINE[1-3]（線グラフ。LINE1（細） 〜 LINE3（太）の3種類から選択）
                    STACK（既存のAREA、或いはLINEに値を上乗せして描画） 
  vname#rrggbb      グラフ化するデータソース名と、描画する際の色指定を行なう。 
  Legend            凡例に利用する文字列を指定する。 
------------------------------------------------------------------------------
```

- グラフ下部に変数の値を書き出す：GPRINTの定義
  - CFによって演算されたデータソースの値をグラフ下部に書き出すにはGPRINTを利用する。 凡例に対する、平均値、最大値、現在値などの情報を数値として書き出すような場合に使用される。 GPRINT:vname:CF:format の4つのフィールドを指定する。
```
------------------------------------------------------------------------------
  [フィールド]     [説明]
------------------------------------------------------------------------------
  GPRINT           グラフ下部に書き出す情報の定義の宣言。 
  vname            既知の変数名の指定。 
  CF               結合関数（CF）を指定する。
                   AVERAGE、MAX、MIN、LASTのいずれかを指定する。 
  format           書式の指定。
                   %n.mlf(n,mは数値)
                   %s(それぞれ値をk[キロ],m[メガ]などの単位で表現する)
                   %S(%sとほぼ同様だが、%sと異なるのは直前で利用された単位にあわせる)
------------------------------------------------------------------------------
```

## 更新操作
### RRDデータの更新について
先ほど作成したrrd(ここではtraffic.rrdとする)にデータを格納する場合には以下の様にして 実行する。 ここでは、受信データが7204129byte、送信データが8445607byteの場合を意味します。
```
# rrdtool update traffic.rrd N:7204129:8445607
```

つまり、SNMPなどを利用してリモートのトラフィック情報を取得し、ラウンドロビンデータベースを 更新するのであれば以下の様なスクリプトを作成してcronで数分毎に実行すればよい。
```
#!/bin/bash

# 変数定義
RRD=/path/to/traffic.rrd                       # RRDファイルのパス
PATH=$PATH:/usr/bin:/usr/local/rrdtool/bin     # rrdtoolコマンドの場所指定
COMMUNITY=community_name                       # SNMPのコミュニティ名指定
REMOTE=remote_host                             # 監視対象のホスト名orIPアドレス

# snmpgetコマンドで受信/送信データ量の取得
InOctets=`snmpget -c $COMMUNITY -v 1 $REMOTE .1.3.6.1.2.1.2.2.1.10.2 \
           | awk ‘{print $NF}’`
OutOctets=`snmpget -c $COMMUNITY -v 1 $REMOTE .1.3.6.1.2.1.2.2.1.16.2 \
           | awk ‘{print $NF}’`

# ラウンドロビンデータベースの更新
rrdtool update $RRD N:$InOctets:$OutOctets
```



## 情報閲覧

### ラウンドロビンアーカイブ(rrdファイル)をダンプしたい
ラウンドロビンアーカイブ作成後、その情報を確認したい場合、dump サブコマンドを利用する。 ラウンドロビンデータベースの内容はxml形式で出力される。 下記では、省略しているが、以下の順番でXMLで出力されている。
- データの更新間隔や最終更新時刻
- データソース1つめの情報、2つめ、....
- RRA(1つめ)の情報、2つめ、...
```
# rrdtool dump traffic.rrd
 

   0001 
   300  
   1088481600  

   
      in 
      COUNTER 
      600 
      NaN 
      NaN 

     
      UNKN 
      0.0000000000e+00 
      0 
  
  (中略)
```

### rrdファイルの情報を表示する
```
$rrdtool info response.rrd
filename = "response.rrd"
rrd_version = "0003"
step = 300
last_update = 1196911800
ds[response_time].type = "GAUGE"
```

### rrdが最後に更新された時間をUNIXTIMEで知りたい
以下の様にlastオプションを利用すればrrdファイルの最終更新時刻がunixタイムでわかる
```
$rrdtool last response.rrd
1196911800
```


# 参考URL
- rrdtool作者
  - http://tobi.oetiker.ch/hp/
- 第7回　RRDtoolでグラフ化モニタリング (1/8)
  - http://www.itmedia.co.jp/enterprise/articles/0705/30/news022.html
